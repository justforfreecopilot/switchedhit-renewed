<!doctype html>
<html lang="en" class="layout-navbar-fixed layout-menu-fixed layout-compact" dir="ltr" data-skin="default" data-bs-theme="light" data-assets-path="assets/" data-template="vertical-menu-template">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
    <title>{{@title}} - SwitchedHit</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/img/favicon/favicon.ico" />
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="assets/vendor/fonts/iconify-icons.css" />
    
    <!-- Core CSS -->
    <link rel="stylesheet" href="assets/vendor/libs/node-waves/node-waves.css" />
    <link rel="stylesheet" href="assets/vendor/css/core.css" />
    <link rel="stylesheet" href="assets/css/demo.css" />
    <link rel="stylesheet" href="assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
    <link rel="stylesheet" href="assets/vendor/libs/datatables-bs5/datatables.bootstrap5.css" />
    <link rel="stylesheet" href="assets/vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.css" />
    <link rel="stylesheet" href="assets/vendor/libs/select2/select2.css" />
    
    <script src="assets/vendor/js/helpers.js"></script>
    <script src="assets/js/config.js"></script>
</head>

<body>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
        <div class="layout-container">
            <!-- Menu -->
            <aside id="layout-menu" class="layout-menu menu-vertical menu">
                <div class="app-brand demo">
                    <a href="/dashboard" class="app-brand-link">
                        <span class="app-brand-text demo menu-text fw-bold ms-2">SwitchedHit</span>
                    </a>
                    <a href="javascript:void(0);" class="layout-menu-toggle menu-link text-large ms-auto d-block d-xl-none">
                        <i class="icon-base ri ri-close-line align-middle"></i>
                    </a>
                </div>

                <div class="menu-inner-shadow"></div>

                <ul class="menu-inner py-1">
                    <!-- Dashboard -->
                    <li class="menu-item">
                        <a href="/dashboard" class="menu-link">
                            <i class="menu-icon icon-base ri ri-dashboard-line"></i>
                            <div>Dashboard</div>
                        </a>
                    </li>

                    <!-- Squad Management -->
                    <li class="menu-item active open">
                        <a href="javascript:void(0);" class="menu-link menu-toggle">
                            <i class="menu-icon icon-base ri ri-team-line"></i>
                            <div>Squad</div>
                        </a>
                        <ul class="menu-sub">
                            <li class="menu-item active">
                                <a href="/players" class="menu-link">
                                    <div>Player List</div>
                                </a>
                            </li>
                            <li class="menu-item">
                                <a href="/team-composition" class="menu-link">
                                    <div>Lineup Management</div>
                                </a>
                            </li>
                        </ul>
                    </li>

                    <!-- Cricket Features -->
                    <li class="menu-item">
                        <a href="javascript:void(0);" class="menu-link">
                            <i class="menu-icon icon-base ri ri-trophy-line"></i>
                            <div>Matches</div>
                        </a>
                    </li>

                    <li class="menu-item">
                        <a href="javascript:void(0);" class="menu-link">
                            <i class="menu-icon icon-base ri ri-bar-chart-line"></i>
                            <div>Statistics</div>
                        </a>
                    </li>

                    <li class="menu-item">
                        <a href="javascript:void(0);" class="menu-link">
                            <i class="menu-icon icon-base ri ri-settings-line"></i>
                            <div>Team Settings</div>
                        </a>
                    </li>
                </ul>
            </aside>
            <!-- / Menu -->

            <!-- Layout container -->
            <div class="layout-page">
                <!-- Navbar -->
                <nav class="layout-navbar container-xxl navbar-detached navbar navbar-expand-xl align-items-center bg-navbar-theme" id="layout-navbar">
                    <div class="layout-menu-toggle navbar-nav align-items-xl-center me-4 me-xl-0 d-xl-none">
                        <a class="nav-item nav-link px-0 me-xl-6" href="javascript:void(0)">
                            <i class="icon-base ri ri-menu-line icon-22px"></i>
                        </a>
                    </div>

                    <div class="navbar-nav-right d-flex align-items-center justify-content-end" id="navbar-collapse">
                        <ul class="navbar-nav flex-row align-items-center ms-auto">
                            <!-- User -->
                            <li class="nav-item navbar-dropdown dropdown-user dropdown">
                                <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
                                    <div class="avatar avatar-online">
                                        <img src="assets/img/avatars/1.png" alt="avatar" class="rounded-circle" />
                                    </div>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end mt-3 py-2">
                                    <li>
                                        <a class="dropdown-item" href="/dashboard">
                                            <i class="icon-base ri ri-user-3-line icon-22px me-3"></i>
                                            <span class="align-middle">Dashboard</span>
                                        </a>
                                    </li>
                                    <li>
                                        <div class="dropdown-divider"></div>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="javascript:void(0);" onclick="logout()">
                                            <i class="icon-base ri ri-logout-box-r-line icon-22px me-3"></i>
                                            <span class="align-middle">Logout</span>
                                        </a>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </nav>
                <!-- / Navbar -->

                <!-- Content wrapper -->
                <div class="content-wrapper">
                    <!-- Content -->
                    <div class="container-xxl flex-grow-1 container-p-y">
                        <h4 class="py-3 mb-4">
                            <span class="text-muted fw-light">Squad /</span> Cricket Players
                        </h4>

                        <!-- Player Stats Cards -->
                        <div class="row g-6 mb-6">
                            <div class="col-sm-6 col-xl-3">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div class="me-1">
                                                <p class="text-heading mb-1">Total Players</p>
                                                <div class="d-flex align-items-center">
                                                    <h4 class="mb-1 me-2" id="total-players">0</h4>
                                                </div>
                                                <small class="mb-0">In your squad</small>
                                            </div>
                                            <div class="avatar">
                                                <div class="avatar-initial bg-label-primary rounded-3">
                                                    <i class="icon-base ri ri-team-line icon-26px"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-xl-3">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div class="me-1">
                                                <p class="text-heading mb-1">Average Age</p>
                                                <div class="d-flex align-items-center">
                                                    <h4 class="mb-1 me-1" id="avg-age">0</h4>
                                                    <span class="text-muted">years</span>
                                                </div>
                                                <small class="mb-0">Team average</small>
                                            </div>
                                            <div class="avatar">
                                                <div class="avatar-initial bg-label-info rounded-3">
                                                    <i class="icon-base ri ri-calendar-line icon-26px"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-xl-3">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div class="me-1">
                                                <p class="text-heading mb-1">Team Rating</p>
                                                <div class="d-flex align-items-center">
                                                    <h4 class="mb-1 me-1" id="avg-rating">0</h4>
                                                    <span class="text-muted">/100</span>
                                                </div>
                                                <small class="mb-0">Average rating</small>
                                            </div>
                                            <div class="avatar">
                                                <div class="avatar-initial bg-label-success rounded-3">
                                                    <i class="icon-base ri ri-star-line icon-26px"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-xl-3">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div class="me-1">
                                                <p class="text-heading mb-1">Top Player</p>
                                                <div class="d-flex align-items-center">
                                                    <h6 class="mb-1 me-1" id="top-player">-</h6>
                                                </div>
                                                <small class="mb-0" id="top-player-rating">Rating: 0</small>
                                            </div>
                                            <div class="avatar">
                                                <div class="avatar-initial bg-label-warning rounded-3">
                                                    <i class="icon-base ri ri-trophy-line icon-26px"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Players List Table -->
                        <div class="card">
                            <div class="card-header border-bottom">
                                <h5 class="card-title mb-0">Filters</h5>
                                <div class="d-flex justify-content-between align-items-center row gx-5 pt-4 gap-5 gap-md-0">
                                    <div class="col-md-4">
                                        <select id="position-filter" class="form-select">
                                            <option value="">All Positions</option>
                                            <option value="Wicket-keeper">Wicket-keeper</option>
                                            <option value="Opening-batsman">Opening Batsman</option>
                                            <option value="Middle-order">Middle-order Batsman</option>
                                            <option value="Finisher">Finisher</option>
                                            <option value="All-rounder">All-rounder</option>
                                            <option value="Fast-bowler">Fast Bowler</option>
                                            <option value="Spin-bowler">Spin Bowler</option>
                                            <option value="Medium-pacer">Medium Pacer</option>
                                            <option value="Batsman">Batsman</option>
                                            <option value="Bowler">Bowler</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <select id="age-filter" class="form-select">
                                            <option value="">All Ages</option>
                                            <option value="young">Young (18-25)</option>
                                            <option value="prime">Prime (26-30)</option>
                                            <option value="veteran">Veteran (31+)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" id="name-search" class="form-control" placeholder="Search by name...">
                                    </div>
                                </div>
                            </div>
                            <div class="card-datatable">
                                <table class="datatables-players table" id="players-table" data-cy="player-table">
                                    <thead>
                                        <tr>
                                            <th>Player</th>
                                            <th>Position</th>
                                            <th>Age</th>
                                            <th>Rating</th>
                                            <th>Batting Avg</th>
                                            <th>Strike Rate</th>
                                            <th>Bowling Avg</th>
                                            <th>Economy</th>
                                            <th>Fielding</th>
                                            <th>Morale</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be loaded via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- / Content -->

                    <!-- Footer -->
                    <footer class="content-footer footer bg-footer-theme">
                        <div class="container-xxl">
                            <div class="footer-container d-flex align-items-center justify-content-between py-4 flex-md-row flex-column">
                                <div class="mb-2 mb-md-0">
                                    © 2024 SwitchedHit. Made with ❤️
                                </div>
                            </div>
                        </div>
                    </footer>
                    <!-- / Footer -->

                    <div class="content-backdrop fade"></div>
                </div>
                <!-- Content wrapper -->
            </div>
            <!-- / Layout page -->
        </div>

        <!-- Overlay -->
        <div class="layout-overlay layout-menu-toggle"></div>
    </div>

    <!-- Player Detail Modal -->
    <div class="modal fade" id="playerDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="playerDetailModalLabel">Player Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">Basic Info</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Name</label>
                                        <p class="form-text" id="modal-player-name">-</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Position</label>
                                        <p class="form-text" id="modal-player-position">-</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Age</label>
                                        <p class="form-text" id="modal-player-age">-</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Overall Rating</label>
                                        <p class="form-text" id="modal-player-rating">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">Statistics</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Batting Average</label>
                                        <div class="progress mb-1">
                                            <div class="progress-bar bg-primary" role="progressbar" id="modal-batting-bar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted" id="modal-batting-value">0</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Strike Rate</label>
                                        <div class="progress mb-1">
                                            <div class="progress-bar bg-success" role="progressbar" id="modal-strike-bar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted" id="modal-strike-value">0</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Bowling Average</label>
                                        <div class="progress mb-1">
                                            <div class="progress-bar bg-info" role="progressbar" id="modal-bowling-bar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted" id="modal-bowling-value">0</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Economy Rate</label>
                                        <div class="progress mb-1">
                                            <div class="progress-bar bg-secondary" role="progressbar" id="modal-economy-bar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted" id="modal-economy-value">0</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Fielding Rating</label>
                                        <div class="progress mb-1">
                                            <div class="progress-bar bg-warning" role="progressbar" id="modal-fielding-bar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted" id="modal-fielding-value">0/100</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Morale</label>
                                        <div class="progress mb-1">
                                            <div class="progress-bar bg-info" role="progressbar" id="modal-morale-bar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted" id="modal-morale-value">0/100</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Core JS -->
    <script src="assets/vendor/libs/jquery/jquery.js"></script>
    <script src="assets/vendor/libs/popper/popper.js"></script>
    <script src="assets/vendor/js/bootstrap.js"></script>
    <script src="assets/vendor/libs/node-waves/node-waves.js"></script>
    <script src="assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
    <script src="assets/vendor/libs/datatables-bs5/datatables-bootstrap5.js"></script>
    <script src="assets/vendor/libs/select2/select2.js"></script>
    <script src="assets/js/main.js"></script>

    <script>
        // Authentication token management
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
        }

        let playersData = [];
        let filteredData = [];

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login';
        }

        // Load players data
        async function loadPlayers() {
            try {
                const response = await fetch('/api/players/my', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    playersData = data.players;
                    filteredData = [...playersData];
                    updateStats();
                    renderPlayersTable();
                } else if (response.status === 401) {
                    logout();
                } else {
                    console.error('Failed to load players');
                }
            } catch (error) {
                console.error('Error loading players:', error);
            }
        }

        // Update statistics cards
        function updateStats() {
            const totalPlayers = playersData.length;
            const avgAge = totalPlayers > 0 ? (playersData.reduce((sum, p) => sum + p.age, 0) / totalPlayers).toFixed(1) : 0;
            const avgRating = totalPlayers > 0 ? (playersData.reduce((sum, p) => sum + p.overall_rating, 0) / totalPlayers).toFixed(1) : 0;
            const topPlayer = playersData.length > 0 ? playersData.reduce((top, player) => player.overall_rating > top.overall_rating ? player : top) : null;

            document.getElementById('total-players').textContent = totalPlayers;
            document.getElementById('avg-age').textContent = avgAge;
            document.getElementById('avg-rating').textContent = avgRating;
            
            if (topPlayer) {
                document.getElementById('top-player').textContent = topPlayer.name;
                document.getElementById('top-player-rating').textContent = `Rating: ${topPlayer.overall_rating}`;
            }
        }

        // Render players table
        function renderPlayersTable() {
            const tbody = document.querySelector('#players-table tbody');
            tbody.innerHTML = '';

            filteredData.forEach(player => {
                const row = document.createElement('tr');
                row.setAttribute('data-cy', 'player-row');
                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar avatar-sm me-3">
                                <div class="avatar-initial bg-label-primary rounded-circle">
                                    <i class="icon-base ri ri-user-line"></i>
                                </div>
                            </div>
                            <div>
                                <h6 class="mb-0">${player.name}</h6>
                                <small class="text-muted">ID: ${player.id}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-label-info">${player.position}</span>
                    </td>
                    <td>${player.age} years</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <span class="me-2">${player.overall_rating}</span>
                            <div class="progress" style="width: 60px; height: 6px;">
                                <div class="progress-bar" style="width: ${player.overall_rating}%"></div>
                            </div>
                        </div>
                    </td>
                    <td>${player.batting_average || 'N/A'}</td>
                    <td>${player.strike_rate || 'N/A'}</td>
                    <td>${player.bowling_average === 999.00 ? 'N/A' : player.bowling_average}</td>
                    <td>${player.economy_rate === 0.00 ? 'N/A' : player.economy_rate}</td>
                    <td>${player.fielding_rating}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <span class="me-2">${player.morale}</span>
                            <div class="progress" style="width: 60px; height: 6px;">
                                <div class="progress-bar bg-info" style="width: ${player.morale}%"></div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="showPlayerDetail(${player.id})">
                            <i class="icon-base ri ri-eye-line me-1"></i>View
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Show player detail modal
        async function showPlayerDetail(playerId) {
            try {
                const response = await fetch(`/api/players/${playerId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const player = data.player;
                    
                    // Update modal content
                    document.getElementById('modal-player-name').textContent = player.name;
                    document.getElementById('modal-player-position').textContent = player.position;
                    document.getElementById('modal-player-age').textContent = `${player.age} years`;
                    document.getElementById('modal-player-rating').textContent = `${player.overall_rating}/100`;
                    
                    // Update cricket stats progress bars
                    const battingPercent = Math.min(100, (player.batting_average / 70) * 100);
                    document.getElementById('modal-batting-bar').style.width = `${battingPercent}%`;
                    document.getElementById('modal-batting-value').textContent = player.batting_average || 'N/A';
                    
                    const strikePercent = Math.min(100, (player.strike_rate / 200) * 100);
                    document.getElementById('modal-strike-bar').style.width = `${strikePercent}%`;
                    document.getElementById('modal-strike-value').textContent = player.strike_rate || 'N/A';
                    
                    const bowlingPercent = player.bowling_average === 999 ? 0 : Math.min(100, ((50 - player.bowling_average) / 50) * 100);
                    document.getElementById('modal-bowling-bar').style.width = `${bowlingPercent}%`;
                    document.getElementById('modal-bowling-value').textContent = player.bowling_average === 999 ? 'N/A' : player.bowling_average;
                    
                    const economyPercent = player.economy_rate === 0 ? 0 : Math.min(100, ((15 - player.economy_rate) / 15) * 100);
                    document.getElementById('modal-economy-bar').style.width = `${economyPercent}%`;
                    document.getElementById('modal-economy-value').textContent = player.economy_rate === 0 ? 'N/A' : player.economy_rate;
                    
                    document.getElementById('modal-fielding-bar').style.width = `${player.fielding_rating}%`;
                    document.getElementById('modal-fielding-value').textContent = `${player.fielding_rating}/100`;
                    
                    document.getElementById('modal-morale-bar').style.width = `${player.morale}%`;
                    document.getElementById('modal-morale-value').textContent = `${player.morale}/100`;
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('playerDetailModal'));
                    modal.show();
                } else {
                    console.error('Failed to load player details');
                }
            } catch (error) {
                console.error('Error loading player details:', error);
            }
        }

        // Filter functions
        function applyFilters() {
            const positionFilter = document.getElementById('position-filter').value;
            const ageFilter = document.getElementById('age-filter').value;
            const nameSearch = document.getElementById('name-search').value.toLowerCase();

            filteredData = playersData.filter(player => {
                // Position filter
                if (positionFilter && player.position !== positionFilter) {
                    return false;
                }

                // Age filter
                if (ageFilter) {
                    if (ageFilter === 'young' && (player.age < 18 || player.age > 25)) return false;
                    if (ageFilter === 'prime' && (player.age < 26 || player.age > 30)) return false;
                    if (ageFilter === 'veteran' && player.age < 31) return false;
                }

                // Name search
                if (nameSearch && !player.name.toLowerCase().includes(nameSearch)) {
                    return false;
                }

                return true;
            });

            renderPlayersTable();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            loadPlayers();

            // Filter event listeners
            document.getElementById('position-filter').addEventListener('change', applyFilters);
            document.getElementById('age-filter').addEventListener('change', applyFilters);
            document.getElementById('name-search').addEventListener('input', applyFilters);
        });
    </script>
</body>
</html>